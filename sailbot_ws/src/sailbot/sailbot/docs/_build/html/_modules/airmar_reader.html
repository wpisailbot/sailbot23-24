<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>airmar_reader &#8212; sailbot 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=af2ce170"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for airmar_reader</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">rclpy.lifecycle</span> <span class="kn">import</span> <span class="n">LifecycleNode</span><span class="p">,</span> <span class="n">LifecycleState</span><span class="p">,</span> <span class="n">TransitionCallbackReturn</span>
<span class="kn">from</span> <span class="nn">rclpy.lifecycle</span> <span class="kn">import</span> <span class="n">Publisher</span>
<span class="kn">from</span> <span class="nn">rclpy.lifecycle</span> <span class="kn">import</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">rclpy.lifecycle</span> <span class="kn">import</span> <span class="n">TransitionCallbackReturn</span>
<span class="kn">from</span> <span class="nn">rclpy.timer</span> <span class="kn">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">rclpy.subscription</span> <span class="kn">import</span> <span class="n">Subscription</span>

<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span><span class="p">,</span> <span class="n">Float64</span>
<span class="kn">from</span> <span class="nn">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">NavSatFix</span>
<span class="kn">from</span> <span class="nn">sailbot_msgs.msg</span> <span class="kn">import</span> <span class="n">Wind</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">traceback</span>


<div class="viewcode-block" id="AirmarReader"><a class="viewcode-back" href="../airmar_reader.html#airmar_reader.AirmarReader">[docs]</a><span class="k">class</span> <span class="nc">AirmarReader</span><span class="p">(</span><span class="n">LifecycleNode</span><span class="p">):</span> <span class="c1">#translates airmar data into json and publishes on &#39;airmar_data&#39; ROS2 topic</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ROS 2 lifecycle node that handles reading and interpreting NMEA data from an Airmar sensor, publishing the data as</span>
<span class="sd">    structured JSON on various ROS topics.</span>

<span class="sd">    This node is responsible for establishing a serial connection to an Airmar sensor, parsing the incoming NMEA sentences,</span>
<span class="sd">    and distributing the processed data through a set of ROS publishers for various types of data including navigation,</span>
<span class="sd">    environmental conditions, and vessel dynamics.</span>

<span class="sd">    :ivar publisher_: General publisher for raw JSON formatted data.</span>
<span class="sd">    :ivar rot_publisher: Publisher for vessel&#39;s rate of turn.</span>
<span class="sd">    :ivar navsat_publisher: Publisher for latitude and longitude data.</span>
<span class="sd">    :ivar track_degrees_true_publisher: Publisher for true heading.</span>
<span class="sd">    :ivar track_degrees_magnetic_publisher: Publisher for magnetic heading.</span>
<span class="sd">    :ivar speed_knots_publisher: Publisher for speed in knots.</span>
<span class="sd">    :ivar speed_kmh_publisher: Publisher for speed in kilometers per hour.</span>
<span class="sd">    :ivar heading_publisher: Publisher for compass heading.</span>
<span class="sd">    :ivar true_wind_publisher: Publisher for true wind data.</span>
<span class="sd">    :ivar apparent_wind_publisher: Publisher for apparent wind data.</span>
<span class="sd">    :ivar roll_publisher: Publisher for vessel roll data.</span>
<span class="sd">    :ivar pitch_publisher: Publisher for vessel pitch data.</span>

<span class="sd">    **Lifecycle States**:</span>
<span class="sd">    - **Configuring**: Establishes the serial connection and sets up the publishers.</span>
<span class="sd">    - **Activating**: Starts the timers and publishers.</span>
<span class="sd">    - **Deactivating**: Stops the timers and publishers.</span>
<span class="sd">    - **Cleaning up**: Destroys the timers and publishers.</span>
<span class="sd">    - **Shutting down**: Closes the serial port and performs any final cleanup.</span>

<span class="sd">    The node subscribes to no topics directly but instead pulls data continuously from the serial port connected to the Airmar sensor.</span>
<span class="sd">    It publishes the processed data to various topics depending on the type of data (e.g., navigational, environmental).</span>

<span class="sd">    **Timer Callbacks**:</span>
<span class="sd">    - **timer_callback**: Regularly called to read from the serial port, parse the received data, and publish the results.</span>

<span class="sd">    </span>
<span class="sd">    **Usage**:</span>
<span class="sd">    - The node must be managed by state_manager</span>

<span class="sd">    **Notes**:</span>
<span class="sd">    - Usage of this node requires a serial port connection to an Airmar weatherstation, currently provided by a Maretron USB100.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;airmar_reader&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rot_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">navsat_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_degrees_true_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_degrees_magnetic_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_knots_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_kmh_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heading_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_wind_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apparent_wind_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roll_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitch_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">error_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>

    <span class="c1">#lifecycle node callbacks</span>
<div class="viewcode-block" id="AirmarReader.on_configure"><a class="viewcode-back" href="../airmar_reader.html#airmar_reader.AirmarReader.on_configure">[docs]</a>    <span class="k">def</span> <span class="nf">on_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LifecycleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;In configure&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="s1">&#39;/dev/serial/by-id/usb-Maretron_USB100__NMEA_2000_USB_Gateway__1163885-if00&#39;</span>
            <span class="c1"># try:</span>
            <span class="c1">#     # Attempt to open and immediately close the port</span>
            <span class="c1">#     ser = serial.Serial(port)</span>
            <span class="c1">#     ser.close()</span>
            <span class="c1"># except serial.SerialException as e:</span>
            <span class="c1">#     print(f&quot;Failed to reset port: {e}&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TransitionCallbackReturn</span><span class="o">.</span><span class="n">FAILURE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s1">&#39;airmar_data&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rot_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">Float64</span><span class="p">,</span> <span class="s1">&#39;airmar_data/rate_of_turn&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">navsat_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">NavSatFix</span><span class="p">,</span> <span class="s1">&#39;airmar_data/lat_long&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_degrees_true_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">Float64</span><span class="p">,</span> <span class="s1">&#39;airmar_data/track_degrees_true&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_degrees_magnetic_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">Float64</span><span class="p">,</span> <span class="s1">&#39;airmar_data/track_degrees_magnetic&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_knots_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">Float64</span><span class="p">,</span> <span class="s1">&#39;airmar_data/speed_knots&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_kmh_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">Float64</span><span class="p">,</span> <span class="s1">&#39;airmar_data/speed_kmh&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heading_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">Float64</span><span class="p">,</span> <span class="s1">&#39;airmar_data/heading&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_wind_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">Wind</span><span class="p">,</span> <span class="s1">&#39;airmar_data/true_wind&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apparent_wind_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">Wind</span><span class="p">,</span> <span class="s1">&#39;airmar_data/apparent_wind&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roll_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">Float64</span><span class="p">,</span> <span class="s1">&#39;airmar_data/roll&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitch_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">Float64</span><span class="p">,</span> <span class="s1">&#39;airmar_data/pitch&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">error_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s1">/error&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer_callback</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TransitionCallbackReturn</span><span class="o">.</span><span class="n">SUCCESS</span></div>

<div class="viewcode-block" id="AirmarReader.on_activate"><a class="viewcode-back" href="../airmar_reader.html#airmar_reader.AirmarReader.on_activate">[docs]</a>    <span class="k">def</span> <span class="nf">on_activate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Activating...&quot;</span><span class="p">)</span>
        <span class="c1"># Start publishers or timers</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_activate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></div>

<div class="viewcode-block" id="AirmarReader.on_deactivate"><a class="viewcode-back" href="../airmar_reader.html#airmar_reader.AirmarReader.on_deactivate">[docs]</a>    <span class="k">def</span> <span class="nf">on_deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deactivating...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_deactivate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></div>

<div class="viewcode-block" id="AirmarReader.on_cleanup"><a class="viewcode-back" href="../airmar_reader.html#airmar_reader.AirmarReader.on_cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">on_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up...&quot;</span><span class="p">)</span>
        <span class="c1"># Destroy subscribers, publishers, and timers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rot_publisher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">navsat_publisher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_degrees_true_publisher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_degrees_magnetic_publisher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_knots_publisher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_kmh_publisher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading_publisher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">true_wind_publisher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apparent_wind_publisher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roll_publisher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch_publisher</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TransitionCallbackReturn</span><span class="o">.</span><span class="n">SUCCESS</span></div>

<div class="viewcode-block" id="AirmarReader.timer_callback"><a class="viewcode-back" href="../airmar_reader.html#airmar_reader.AirmarReader.timer_callback">[docs]</a>    <span class="k">def</span> <span class="nf">timer_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readLineToJson</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>
        <span class="c1">#self.get_logger().info(&#39;Publishing: &quot;%s&quot;&#39; % msg.data)</span>

<div class="viewcode-block" id="AirmarReader.publishIfValid"><a class="viewcode-back" href="../airmar_reader.html#airmar_reader.AirmarReader.publishIfValid">[docs]</a>    <span class="k">def</span> <span class="nf">publishIfValid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">publisher</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates and publishes the given value using the specified publisher based on the data type. This function is designed</span>
<span class="sd">        to ensure that only valid data is published to ROS topics.</span>

<span class="sd">        :param value: The value to be published. Depending on the type, this can be a single value or a tuple of values.</span>
<span class="sd">        :param publisher: The ROS publisher object used to publish the data.</span>
<span class="sd">        :param type: The data type class which defines how to interpret &#39;value&#39;. This can be one of several expected ROS message types</span>
<span class="sd">                    such as &#39;Float64&#39;, &#39;Wind&#39;, or &#39;NavSatFix&#39;.</span>

<span class="sd">        :return: None. This function does not return a value but instead publishes data to a ROS topic if the data is valid.</span>

<span class="sd">        Function behavior includes:</span>
<span class="sd">        - Checking the specified &#39;type&#39; and constructing a corresponding ROS message object.</span>
<span class="sd">        - Attempting to cast &#39;value&#39; to the appropriate type(s) required by the ROS message.</span>
<span class="sd">        - If casting is successful and the value is valid, the data is published using the provided &#39;publisher&#39;.</span>
<span class="sd">        - If an error occurs during casting or validation, the function catches the exception and refrains from publishing,</span>
<span class="sd">        optionally logging the error or ignoring invalid data.</span>

<span class="sd">        This function supports multiple ROS data types and can be extended to include more types as needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#self.get_logger().info(&quot;Checking validity: &quot;)</span>
        <span class="c1">#self.get_logger().info(str(type))</span>
        <span class="c1">#self.get_logger().info(str(value))</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">Float64</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">Float64</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                <span class="n">publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1">#self.get_logger().error(traceback.format_exc())</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">Wind</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">Wind</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">NavSatFix</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">NavSatFix</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">latitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">longitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">position_covariance_type</span> <span class="o">=</span> <span class="n">NavSatFix</span><span class="o">.</span><span class="n">COVARIANCE_TYPE_UNKNOWN</span>
                <span class="n">publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Published latlong!&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;publishIfValid: unimplemented type&quot;</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="AirmarReader.readLineToJson"><a class="viewcode-back" href="../airmar_reader.html#airmar_reader.AirmarReader.readLineToJson">[docs]</a>    <span class="k">def</span> <span class="nf">readLineToJson</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads a line from a serial input, decodes it, and interprets various NMEA sentences into structured JSON-like dictionaries</span>
<span class="sd">        based on the sentence type. The function handles various NMEA sentence codes by parsing and publishing appropriate data</span>
<span class="sd">        while logging relevant information.</span>

<span class="sd">        :return: A dictionary representing the parsed data from the NMEA sentence. This dictionary&#39;s structure varies depending</span>
<span class="sd">                on the type of NMEA sentence processed. The function returns an empty dictionary for certain NMEA sentence types</span>
<span class="sd">                that are deemed unnecessary or redundant.</span>

<span class="sd">        This function primarily processes data for navigation and environmental monitoring, converting raw NMEA sentence inputs</span>
<span class="sd">        into more structured data forms. It handles a variety of NMEA sentence types including GPS position data (&#39;GLL&#39;),</span>
<span class="sd">        rate of turn (&#39;ROT&#39;), speed and heading information (&#39;VTG&#39;), environmental data like temperature and atmospheric pressure (&#39;XDR&#39;),</span>
<span class="sd">        and wind data (&#39;MWV&#39;, &#39;MWD&#39;). It also includes error handling to manage exceptions during the read and parse operations.</span>

<span class="sd">        Function behavior includes:</span>
<span class="sd">        </span>
<span class="sd">        - Reading and decoding a line from the serial port.</span>
<span class="sd">        - Splitting the line based on commas to differentiate data fields and removing any checksums.</span>
<span class="sd">        - Identifying the sentence type through a code in the tag and processing accordingly.</span>
<span class="sd">        - Publishing valid data to appropriate ROS topics using helper functions.</span>
<span class="sd">        - Logging significant actions and data points for debugging purposes.</span>
<span class="sd">        - Returning structured data as a dictionary where applicable, or an empty dictionary for unsupported or unnecessary data types.</span>

<span class="sd">        This function assumes the availability of a serial port connection, currently to a Maretron USB100.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="c1">#self.get_logger().info(line)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">type_code</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#get rid of checksum</span>

            <span class="k">if</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;ROT&#39;</span><span class="p">):</span> <span class="c1">#rate of turn degrees per minute. negative is to port</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publishIfValid</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rot_publisher</span><span class="p">,</span> <span class="n">Float64</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;rate-of-turn&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;GLL&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got GPS data: &quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="c1">#convert from degree decimal minutes to decimal degrees</span>
                <span class="c1">#dd = d + m/60</span>
                <span class="c1">#lat = math.floor(float(args[1]) / 100) + (float(args[1]) % 100)/60.0</span>
                <span class="c1">#lon = math.floor(float(args[3]) / 100) + (float(args[3]) % 100)/60.0</span>
                <span class="n">lat_raw</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">lon_raw</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">lat_raw</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">lon_raw</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">{}</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lat_raw</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">lat_raw</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span><span class="o">/</span><span class="mf">60.0</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lon_raw</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">lon_raw</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span><span class="o">/</span><span class="mf">60.0</span>
                <span class="k">if</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">):</span>
                    <span class="n">lat</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">):</span>
                    <span class="n">lon</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publishIfValid</span><span class="p">([</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">navsat_publisher</span><span class="p">,</span> <span class="n">NavSatFix</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Publishing latlong&quot;</span><span class="p">)</span>

                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;Latitude&quot;</span><span class="p">:</span><span class="n">lat</span><span class="p">,</span>
                        <span class="s2">&quot;Latitude-direction&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="s2">&quot;Longitude&quot;</span><span class="p">:</span><span class="n">lon</span><span class="p">,</span>
                        <span class="s2">&quot;Longitude-direction&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]}</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;VTG&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publishIfValid</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_degrees_true_publisher</span><span class="p">,</span> <span class="n">Float64</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publishIfValid</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_degrees_magnetic_publisher</span><span class="p">,</span> <span class="n">Float64</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publishIfValid</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_knots_publisher</span><span class="p">,</span> <span class="n">Float64</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publishIfValid</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_kmh_publisher</span><span class="p">,</span> <span class="n">Float64</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;track-degrees-true&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;track-degrees-magnetic&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                        <span class="s2">&quot;speed-knots&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                        <span class="s2">&quot;speed-kmh&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">7</span><span class="p">]}</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;XDR&#39;</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ENV_OUTSIDE_T&quot;</span><span class="p">):</span> <span class="c1">#in celcius</span>
                    <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;outside-temp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ENV_ATMOS_P&quot;</span><span class="p">):</span> <span class="c1">#in ???</span>
                    <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;atmospheric-pressure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ENV_OUTSIDE_T&quot;</span><span class="p">):</span> <span class="c1">#in celcius</span>
                        <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;outside-temp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                    <span class="k">elif</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ENV_ATMOS_P&quot;</span><span class="p">):</span> <span class="c1">#in ???</span>
                        <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;atmospheric-pressure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">ret</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;HDG&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Publishing heading&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publishIfValid</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading_publisher</span><span class="p">,</span> <span class="n">Float64</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;currentHeading&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1">#degrees</span>
                        <span class="s2">&quot;magnetic-deviation&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="c1">#degrees</span>
                        <span class="s2">&quot;magnetic-deviation-direction&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                        <span class="s2">&quot;magnetic-variation&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="c1">#degrees</span>
                        <span class="s2">&quot;magnetic-variation-direction&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">]}</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;VHW&#39;</span><span class="p">):</span> <span class="c1">#water speed and direction (speed not showing up)</span>
                <span class="k">return</span> <span class="p">{}</span>  <span class="c1">#not sure we need</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;GGA&#39;</span><span class="p">):</span> <span class="c1">#GPS position, quality, elevation, # of satilites</span>
                <span class="k">return</span> <span class="p">{}</span> <span class="c1">#not sure needed, repeated gps from GLL</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;DTM&#39;</span><span class="p">):</span> <span class="c1">#unreferenced in documentation except as datnum reference -- unusable</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;GSV&#39;</span><span class="p">):</span> <span class="c1">#GPS satilites in view</span>
                <span class="k">return</span> <span class="p">{}</span> <span class="c1">#no need for this data</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;GSA&#39;</span><span class="p">):</span> <span class="c1"># GPS Dilution of Precision</span>
                <span class="k">return</span> <span class="p">{}</span> <span class="c1">#not sure if needed</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;GRS&#39;</span><span class="p">):</span> <span class="c1">#&quot;The GRS message is used to support the Receiver Autonomous Integrity Monitoring (RAIM).&quot; -- unneeded</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;MWD&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got true wind!&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publishIfValid</span><span class="p">([</span><span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_wind_publisher</span><span class="p">,</span> <span class="n">Wind</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;trueWind&quot;</span><span class="p">:</span>
                    <span class="p">{</span><span class="s2">&quot;speed&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>      <span class="c1">#in knots</span>
                     <span class="c1">#&quot;speed&quot;: args[7]      for reporting in m/s</span>
                    <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1">#in deg</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;MWV&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publishIfValid</span><span class="p">([</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">apparent_wind_publisher</span><span class="p">,</span> <span class="n">Wind</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got apparent wind: </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;apparentWind&quot;</span><span class="p">:</span>
                    <span class="p">{</span><span class="s2">&quot;speed&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>       <span class="c1">#in knots </span>
                    <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1">#in deg</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;ZDA&#39;</span><span class="p">):</span> <span class="c1">#date &amp; time</span>
                <span class="k">return</span> <span class="p">{}</span> <span class="c1"># unneeded</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">type_code</span> <span class="o">==</span> <span class="s1">&#39;OUT&#39;</span><span class="p">):</span> <span class="c1">#real key is &#39;PMAROUT&#39;, shortened to OUT, since all others are 3 letters</span>
                <span class="c1">#&quot;PGN is translated to a Maretron proprietary NMEA 0183 sentence &quot; -- used for pitch and roll</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publishIfValid</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch_publisher</span><span class="p">,</span> <span class="n">Float64</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publishIfValid</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll_publisher</span><span class="p">,</span> <span class="n">Float64</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span> <span class="s2">&quot;pitchroll&quot;</span><span class="p">:</span>
                        <span class="p">{</span><span class="s2">&quot;roll&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="s2">&quot;pitch&quot;</span><span class="p">:</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]}</span>
                        <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1">#raise ValueError(&quot;Unknown NEMA code: &quot; + type_code)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span><span class="p">({})</span></div>
    
<div class="viewcode-block" id="AirmarReader.publish_error"><a class="viewcode-back" href="../airmar_reader.html#airmar_reader.AirmarReader.publish_error">[docs]</a>    <span class="k">def</span> <span class="nf">publish_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="n">error_msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../airmar_reader.html#airmar_reader.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">airmar_reader</span> <span class="o">=</span> <span class="n">AirmarReader</span><span class="p">()</span>
    <span class="n">airmar_reader</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

    <span class="c1"># Use the SingleThreadedExecutor to spin the node.</span>
    <span class="n">executor</span> <span class="o">=</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">executors</span><span class="o">.</span><span class="n">SingleThreadedExecutor</span><span class="p">()</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">airmar_reader</span><span class="p">)</span>

    <span class="c1"># def signal_handler(sig, frame):</span>
    <span class="c1">#     airmar_reader.get_logger().info(&#39;You pressed Ctrl+C! Closing serial connection...&#39;)</span>
    <span class="c1">#     airmar_reader.ser.close()</span>
    <span class="c1"># signal.signal(signal.SIGINT, signal_handler)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Spin the node to execute callbacks</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">error_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Unhandled exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">trace</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">airmar_reader</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
        <span class="n">airmar_reader</span><span class="o">.</span><span class="n">publish_error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Shutdown and cleanup the node</span>
        <span class="n">airmar_reader</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">airmar_reader</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">sailbot</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../airmar_reader.html">Airmar Reader Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ballast_control.html">Ballast Control Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../buoy_detection.html">Buoy Detection Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../esp32_comms.html">ESP32 Comms Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../heading_controller_vf.html">Heading Controller Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network_comms.html">Network Comms Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../path_follower_vf.html">Path Follower Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../state_manager.html">State Manager Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wind_smoother.html">Wind Smoother Node</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2024, Matthew Gomes.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>