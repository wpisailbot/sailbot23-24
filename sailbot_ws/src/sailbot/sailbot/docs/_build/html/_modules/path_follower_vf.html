<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>path_follower_vf &#8212; sailbot 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=af2ce170"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for path_follower_vf</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span><span class="p">,</span> <span class="n">Float64</span><span class="p">,</span> <span class="n">Int16</span><span class="p">,</span> <span class="n">Header</span>
<span class="kn">from</span> <span class="nn">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">NavSatFix</span>
<span class="kn">from</span> <span class="nn">nav_msgs.msg</span> <span class="kn">import</span> <span class="n">OccupancyGrid</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">PoseStamped</span><span class="p">,</span> <span class="n">Quaternion</span>
<span class="kn">from</span> <span class="nn">geographic_msgs.msg</span> <span class="kn">import</span> <span class="n">GeoPoint</span>
<span class="kn">from</span> <span class="nn">sailbot_msgs.msg</span> <span class="kn">import</span> <span class="n">GeoPath</span><span class="p">,</span> <span class="n">Waypoint</span><span class="p">,</span> <span class="n">WaypointPath</span><span class="p">,</span> <span class="n">Wind</span><span class="p">,</span> <span class="n">GaussianThreat</span><span class="p">,</span> <span class="n">PathSegment</span><span class="p">,</span> <span class="n">GeoPathSegment</span><span class="p">,</span> <span class="n">BuoyDetectionStamped</span>
<span class="kn">from</span> <span class="nn">sailbot_msgs.srv</span> <span class="kn">import</span> <span class="n">SetMap</span><span class="p">,</span> <span class="n">GetPath</span><span class="p">,</span> <span class="n">SetThreat</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">rclpy.lifecycle</span> <span class="kn">import</span> <span class="n">LifecycleNode</span><span class="p">,</span> <span class="n">LifecycleState</span><span class="p">,</span> <span class="n">TransitionCallbackReturn</span>
<span class="kn">from</span> <span class="nn">rclpy.lifecycle</span> <span class="kn">import</span> <span class="n">Publisher</span>
<span class="kn">from</span> <span class="nn">rclpy.lifecycle</span> <span class="kn">import</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">rclpy.lifecycle</span> <span class="kn">import</span> <span class="n">TransitionCallbackReturn</span>
<span class="kn">from</span> <span class="nn">rclpy.timer</span> <span class="kn">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">rclpy.subscription</span> <span class="kn">import</span> <span class="n">Subscription</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">ParameterType</span>
<span class="kn">from</span> <span class="nn">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pyproj</span> <span class="kn">import</span> <span class="n">Transformer</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">geopy.distance</span> <span class="kn">import</span> <span class="n">great_circle</span>
<span class="kn">from</span> <span class="nn">geopy.distance</span> <span class="kn">import</span> <span class="n">geodesic</span>
<span class="kn">from</span> <span class="nn">geopy.point</span> <span class="kn">import</span> <span class="n">Point</span> <span class="k">as</span> <span class="n">geopy_point</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">radians</span><span class="p">,</span> <span class="n">degrees</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>

<div class="viewcode-block" id="get_maps_dir"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.get_maps_dir">[docs]</a><span class="k">def</span> <span class="nf">get_maps_dir</span><span class="p">():</span>
    <span class="n">package_path</span> <span class="o">=</span> <span class="n">get_package_share_directory</span><span class="p">(</span><span class="s1">&#39;sailbot&#39;</span><span class="p">)</span>
    <span class="n">resource_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package_path</span><span class="p">,</span> <span class="s1">&#39;maps&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resource_path</span></div>

<div class="viewcode-block" id="distance"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.distance">[docs]</a><span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
    <span class="n">x2x1</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span>
    <span class="n">y2y1</span> <span class="o">=</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x2x1</span><span class="o">*</span><span class="n">x2x1</span> <span class="o">+</span> <span class="n">y2y1</span><span class="o">*</span><span class="n">y2y1</span><span class="p">)</span></div>

<div class="viewcode-block" id="interpolate_point"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.interpolate_point">[docs]</a><span class="k">def</span> <span class="nf">interpolate_point</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">,</span> <span class="n">fraction</span><span class="p">):</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">point1</span><span class="o">.</span><span class="n">latitude</span> <span class="o">+</span> <span class="p">(</span><span class="n">point2</span><span class="o">.</span><span class="n">latitude</span> <span class="o">-</span> <span class="n">point1</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span> <span class="o">*</span> <span class="n">fraction</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">point1</span><span class="o">.</span><span class="n">longitude</span> <span class="o">+</span> <span class="p">(</span><span class="n">point2</span><span class="o">.</span><span class="n">longitude</span> <span class="o">-</span> <span class="n">point1</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span> <span class="o">*</span> <span class="n">fraction</span>
    <span class="k">return</span> <span class="n">GeoPoint</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="n">lon</span><span class="p">)</span></div>

<div class="viewcode-block" id="find_and_load_image"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.find_and_load_image">[docs]</a><span class="k">def</span> <span class="nf">find_and_load_image</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find an image by location and load it along with its bounding box coordinates.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - directory: The directory to search in.</span>
<span class="sd">    - location: The location to match.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - A tuple containing the loaded image and a dictionary with the bounding box coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Regular expression to match the filename format and capture coordinates</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">:(-?\d+\.?\d*):(-?\d+\.?\d*):(-?\d+\.?\d*):(-?\d+\.?\d*)\.png&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="c1"># Extract the bounding box coordinates</span>
            <span class="n">south</span><span class="p">,</span> <span class="n">west</span><span class="p">,</span> <span class="n">north</span><span class="p">,</span> <span class="n">east</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>

            <span class="c1"># Load the image</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="mi">255</span><span class="o">-</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to load image at </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;south&quot;</span><span class="p">:</span> <span class="n">south</span><span class="p">,</span> <span class="s2">&quot;west&quot;</span><span class="p">:</span> <span class="n">west</span><span class="p">,</span> <span class="s2">&quot;north&quot;</span><span class="p">:</span> <span class="n">north</span><span class="p">,</span> <span class="s2">&quot;east&quot;</span><span class="p">:</span> <span class="n">east</span><span class="p">}</span>

    <span class="c1"># Return None if no matching file is found</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PathFollower"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower">[docs]</a><span class="k">class</span> <span class="nc">PathFollower</span><span class="p">(</span><span class="n">LifecycleNode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ROS2 lifecycle node that manages pathfinding and navigation for the boat. It processes waypoints, handles dynamic path updates,</span>
<span class="sd">    manages threats, and integrates sensor data to navigate efficiently.</span>

<span class="sd">    :ivar latitude: Current latitude of the boat.</span>
<span class="sd">    :ivar longitude: Current longitude of the boat.</span>
<span class="sd">    :ivar heading: Current boat heading in degrees.</span>
<span class="sd">    :ivar speed_knots: Current speed of the boat in knots.</span>
<span class="sd">    :ivar wind_angle_deg: Current wind direction in degrees relative to the boat.</span>
<span class="sd">    :ivar waypoints: A &#39;WaypointPath&#39; object containing the waypoints the boat must follow.</span>
<span class="sd">    :ivar current_path: A &#39;GeoPath&#39; object representing the currently planned path.</span>
<span class="sd">    :ivar current_grid_path: List of grid coordinates corresponding to the &#39;current_path&#39;.</span>
<span class="sd">    :ivar segment_endpoint_indices: Indices in the &#39;current_path&#39; where path segments end.</span>
<span class="sd">    :ivar buoy_rounding_distance_meters: Distance for rounding buoys during navigation.</span>
<span class="sd">    :ivar min_path_recalculation_interval_seconds: Minimum interval between path recalculations to avoid excessive updates.</span>
<span class="sd">    :ivar threat_ids: List of internal IDs returned from pathfinder node for identified buoy threats.</span>
<span class="sd">    :ivar previous_look_ahead_index: Last path point the boat was at, tracked to avoid issues with self-intersecting paths.</span>
<span class="sd">    :ivar grid_points: The intermediate step between waypoints and the full grid path, passed to the pathfinder node.</span>
<span class="sd">    :ivar exact_points: The intermediate step between waypoints and the full geographical path.</span>
<span class="sd">    :ivar current_buoy_positions: Dictionary containing a mapping between buoy IDs and their current positions.</span>
<span class="sd">    :ivar last_waypoint_was_rounding_type: Internal state to decide if the last few points might need to be trimmed, as we don&#39;t always want to go fully around a buoy.</span>

<span class="sd">    **Subscriptions**:</span>

<span class="sd">    - &#39;airmar_heading_subscription&#39;: Subscribes to heading updates from the boat&#39;s sensors.</span>
<span class="sd">    - &#39;airmar_position_subscription&#39;: Subscribes to position updates, updating boat&#39;s geographic location.</span>
<span class="sd">    - &#39;airmar_speed_knots_subscription&#39;: Subscribes to speed updates in knots.</span>

<span class="sd">    **Publishers**:</span>

<span class="sd">    - &#39;current_grid_segment_publisher&#39;: Publishes the current segment of the navigation grid being followed.</span>
<span class="sd">    - &#39;current_segment_debug_publisher&#39;: Publishes debug information about the current navigation segment.</span>
<span class="sd">    - &#39;target_position_publisher&#39;: Publishes the target position the boat is navigating towards.</span>
<span class="sd">    - &#39;current_path_publisher&#39;: Publishes updates to the navigation path as it is recalculated.</span>
<span class="sd">    - &#39;current_grid_cell_publisher&#39;: Publishes the current grid cell location of the boat within the navigation map.</span>

<span class="sd">    **Services**:</span>
<span class="sd">    </span>
<span class="sd">    - &#39;set_map_cli&#39;, &#39;get_path_cli&#39;, &#39;set_threat_cli&#39;: Service clients for setting the navigation map, retrieving paths, and managing navigation threats.</span>

<span class="sd">    **Methods**:</span>

<span class="sd">    - &#39;set_parameters&#39;, &#39;get_parameters&#39;: Methods for declaring and retrieving ROS parameters related to navigation and pathfinding.</span>
<span class="sd">    - &#39;calculate_exact_points_from_waypoint&#39;: Processes waypoints to calculate exact navigation points.</span>
<span class="sd">    - &#39;recalculate_path_from_exact_points&#39;: Recalculates the navigation path based on new or updated exact navigation points.</span>
<span class="sd">    - &#39;find_look_ahead&#39;: Determines the boat&#39;s progress along the path.</span>
<span class="sd">    - &#39;remove_last_points_if_necessary&#39;: Trims unnecessary navigation points if the last waypoint was a rounding type.</span>
<span class="sd">    - &#39;get_square_corners&#39;: Calculates and orders the four corners of a square about a target position, facing a starting position.</span>

<span class="sd">    **Usage**:</span>

<span class="sd">    - The node must be managed by state_manager</span>

<span class="sd">    **Notes**:</span>

<span class="sd">    - This is the vector-field variant of the boat&#39;s pathfinding. See path_follower.py for the look-ahead variant.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">heading</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># latitude = 42.273822</span>
    <span class="c1"># longitude = -71.805967</span>
    <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span> <span class="o">=</span> <span class="mf">42.0396766107111</span><span class="p">,</span> <span class="o">-</span><span class="mf">71.84585650616927</span>
    <span class="n">speed_knots</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">waypoints</span> <span class="o">=</span> <span class="n">WaypointPath</span><span class="p">()</span>
    <span class="n">current_path</span> <span class="o">=</span> <span class="n">GeoPath</span><span class="p">()</span>
    <span class="n">current_grid_path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">segment_endpoint_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#current_grid_cell = (16, 51)</span>
    <span class="n">current_grid_cell</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

    <span class="n">wind_angle_deg</span> <span class="o">=</span> <span class="mi">270</span>

    <span class="n">buoy_rounding_distance_meters</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">min_path_recalculation_interval_seconds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">threat_ids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">previous_look_ahead_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">grid_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">exact_points</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">last_recalculation_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">current_buoy_positions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">last_waypoint_was_rounding_type</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">waypoint_threat_id_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;path_follower&#39;</span><span class="p">)</span>
        <span class="c1"># Using different callback groups for subscription and service client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscription_callback_group</span> <span class="o">=</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">callback_groups</span><span class="o">.</span><span class="n">MutuallyExclusiveCallbackGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_client_callback_group</span> <span class="o">=</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">callback_groups</span><span class="o">.</span><span class="n">MutuallyExclusiveCallbackGroup</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_segment_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_segment_debug_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_position_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_path_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell_publisher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Publisher</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">airmar_heading_subscription</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Subscription</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">airmar_position_subscription</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Subscription</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">airmar_speed_knots_subscription</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Subscription</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Timer</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Map name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">map_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting map image&quot;</span><span class="p">)</span>
        <span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">find_and_load_image</span><span class="p">(</span><span class="n">get_maps_dir</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_name</span><span class="p">)</span>
        <span class="c1">#cv2.imwrite(&quot;/home/sailbot/after_load.jpg&quot;, image)</span>


        <span class="n">occupancy_grid_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1">#occupancy_grid_values = ((255 - occupancy_grid_values) * 100 / 255).astype(np.int8)</span>
        <span class="n">grid_msg</span> <span class="o">=</span> <span class="n">OccupancyGrid</span><span class="p">()</span>
        <span class="n">grid_msg</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="n">frame_id</span><span class="o">=</span><span class="s2">&quot;map&quot;</span><span class="p">)</span>
        <span class="n">grid_msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="mf">0.00001</span>
        <span class="n">grid_msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">occupancy_grid_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="n">occupancy_grid_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">grid_msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">occupancy_grid_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span> <span class="o">=</span> <span class="n">occupancy_grid_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;map width: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="si">}</span><span class="s2">, height: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latlong_to_grid_proj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">)</span>

        <span class="n">grid_msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">orientation</span><span class="o">=</span><span class="n">Quaternion</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">occupancy_grid_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">grid_msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">occupancy_grid_values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting SetMap service&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_map_cli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_client</span><span class="p">(</span><span class="n">SetMap</span><span class="p">,</span> <span class="s1">&#39;set_map&#39;</span><span class="p">,</span> <span class="n">callback_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service_client_callback_group</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_map_cli</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="n">timeout_sec</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set_map service not available, waiting again...&#39;</span><span class="p">)</span>
        <span class="n">set_map_req</span> <span class="o">=</span> <span class="n">SetMap</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>
        <span class="n">set_map_req</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">grid_msg</span>
        <span class="n">set_map_req</span><span class="o">.</span><span class="n">num_prm_nodes</span> <span class="o">=</span> <span class="mi">3000</span>
        <span class="n">set_map_req</span><span class="o">.</span><span class="n">prm_connection_distance_percent</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_msg</span> <span class="o">=</span> <span class="n">grid_msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting map&quot;</span><span class="p">)</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_map_cli</span><span class="o">.</span><span class="n">call_async</span><span class="p">(</span><span class="n">set_map_req</span><span class="p">)</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin_until_future_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Map setup done&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_path_cli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_client</span><span class="p">(</span><span class="n">GetPath</span><span class="p">,</span> <span class="s1">&#39;get_path&#39;</span><span class="p">,</span> <span class="n">callback_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service_client_callback_group</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path_cli</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="n">timeout_sec</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_path service not available, waiting again...&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_threat_cli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_client</span><span class="p">(</span><span class="n">SetThreat</span><span class="p">,</span> <span class="s1">&#39;set_threat&#39;</span><span class="p">,</span> <span class="n">callback_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service_client_callback_group</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_threat_cli</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="n">timeout_sec</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set_threat service not available, waiting again...&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Path follower node setup complete&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="PathFollower.set_parameters"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.set_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">set_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.pathfinding.buoy_rounding_distance_meters&#39;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.pathfinding.buoy_threat_size_map_units&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.pathfinding.buoy_threat_guassian_intensity&#39;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.pathfinding.min_path_recalculation_interval_seconds&#39;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.navigation.look_ahead_distance_meters&#39;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.navigation.look_ahead_increase_per_knot&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.navigation.buoy_snap_distance_meters&#39;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;map_name&#39;</span><span class="p">,</span> <span class="s1">&#39;quinsigamond&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PathFollower.get_parameters"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.get_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buoy_rounding_distance_meters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.pathfinding.buoy_rounding_distance_meters&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">()</span><span class="o">.</span><span class="n">double_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buoy_threat_size_map_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.pathfinding.buoy_threat_size_map_units&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">()</span><span class="o">.</span><span class="n">double_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buoy_threat_guassian_intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.pathfinding.buoy_threat_guassian_intensity&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">()</span><span class="o">.</span><span class="n">double_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_path_recalculation_interval_seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.pathfinding.min_path_recalculation_interval_seconds&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">()</span><span class="o">.</span><span class="n">double_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">look_ahead_distance_meters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.navigation.look_ahead_distance_meters&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">()</span><span class="o">.</span><span class="n">double_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">look_ahead_increase_per_knot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.navigation.look_ahead_increase_per_knot&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">()</span><span class="o">.</span><span class="n">double_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buoy_snap_distance_meters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;sailbot.navigation.buoy_snap_distance_meters&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">()</span><span class="o">.</span><span class="n">double_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;map_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">()</span><span class="o">.</span><span class="n">string_value</span></div>

    <span class="c1">#lifecycle node callbacks</span>
<div class="viewcode-block" id="PathFollower.on_configure"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.on_configure">[docs]</a>    <span class="k">def</span> <span class="nf">on_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;In configure&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_segment_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">PathSegment</span><span class="p">,</span> <span class="s1">&#39;current_path_segment&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_segment_debug_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">GeoPathSegment</span><span class="p">,</span> <span class="s1">&#39;current_segment_debug&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_position_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">GeoPoint</span><span class="p">,</span> <span class="s1">&#39;target_position&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_path_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">GeoPath</span><span class="p">,</span> <span class="s1">&#39;current_path&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell_publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_lifecycle_publisher</span><span class="p">(</span><span class="n">Point</span><span class="p">,</span> <span class="s1">&#39;current_grid_cell&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">airmar_heading_subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
                <span class="n">Float64</span><span class="p">,</span>
                <span class="s1">&#39;/airmar_data/heading&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">airmar_heading_callback</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span>
                <span class="n">callback_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription_callback_group</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">airmar_position_subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
                <span class="n">NavSatFix</span><span class="p">,</span>
                <span class="s1">&#39;/airmar_data/lat_long&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">airmar_position_callback</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span>
                <span class="n">callback_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription_callback_group</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">airmar_speed_knots_subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
                <span class="n">Float64</span><span class="p">,</span>
                <span class="s1">&#39;/airmar_data/speed_knots&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">airmar_speed_knots_callback</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span>
                <span class="n">callback_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription_callback_group</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waypoints_subscriber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
                <span class="n">WaypointPath</span><span class="p">,</span> 
                <span class="s1">&#39;waypoints&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">waypoints_callback</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span> 
                <span class="n">callback_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription_callback_group</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_waypoint_subscriber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
                <span class="n">Waypoint</span><span class="p">,</span> 
                <span class="s1">&#39;single_waypoint&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">single_waypoint_callback</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span> 
                <span class="n">callback_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription_callback_group</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">true_wind_subscriber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
                <span class="n">Wind</span><span class="p">,</span>
                <span class="s1">&#39;true_wind_smoothed&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">true_wind_callback</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span>
                <span class="n">callback_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription_callback_group</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buoy_position_subscriber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
                <span class="n">BuoyDetectionStamped</span><span class="p">,</span>
                <span class="s1">&#39;buoy_position&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buoy_position_callback</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span>
                <span class="n">callback_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscription_callback_group</span><span class="p">)</span>
            <span class="c1">#self.timer = self.create_timer(0.1, self.control_loop_callback)</span>
            <span class="c1">#super().on_configure(state)</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Error in configure&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Path following node configured&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">TransitionCallbackReturn</span><span class="o">.</span><span class="n">SUCCESS</span></div>

<div class="viewcode-block" id="PathFollower.on_activate"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.on_activate">[docs]</a>    <span class="k">def</span> <span class="nf">on_activate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Activating...&quot;</span><span class="p">)</span>
        <span class="c1"># Start publishers or timers</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_activate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></div>

<div class="viewcode-block" id="PathFollower.on_deactivate"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.on_deactivate">[docs]</a>    <span class="k">def</span> <span class="nf">on_deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deactivating...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_deactivate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></div>

<div class="viewcode-block" id="PathFollower.on_cleanup"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.on_cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">on_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up...&quot;</span><span class="p">)</span>
        <span class="c1"># Destroy subscribers, publishers, and timers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_lifecycle_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell_publisher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_subscription</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">airmar_heading_subscription</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_subscription</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">airmar_position_subscription</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TransitionCallbackReturn</span><span class="o">.</span><span class="n">SUCCESS</span></div>

<div class="viewcode-block" id="PathFollower.on_shutdown"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.on_shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">on_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shutting down...&quot;</span><span class="p">)</span>
        <span class="c1"># Perform final cleanup if necessary</span>
        <span class="k">return</span> <span class="n">TransitionCallbackReturn</span><span class="o">.</span><span class="n">SUCCESS</span></div>
    
<div class="viewcode-block" id="PathFollower.on_error"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.on_error">[docs]</a>    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LifecycleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Error caught!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></div>
    
    <span class="c1">#end callbacks</span>

<div class="viewcode-block" id="PathFollower.airmar_heading_callback"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.airmar_heading_callback">[docs]</a>    <span class="k">def</span> <span class="nf">airmar_heading_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Float64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#self.get_logger().info(&quot;Got heading&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span></div>
    
<div class="viewcode-block" id="PathFollower.airmar_position_callback"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.airmar_position_callback">[docs]</a>    <span class="k">def</span> <span class="nf">airmar_position_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">NavSatFix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latitude</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">latitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">longitude</span>
        <span class="n">new_grid_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latlong_to_grid_proj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">)</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got new position&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_grid_cell</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell</span> <span class="ow">and</span> <span class="p">(</span><span class="n">current_time</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">last_recalculation_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_path_recalculation_interval_seconds</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recalculating path&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recalculate_path_from_exact_points</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_recalculation_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">find_look_ahead</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell</span> <span class="o">=</span> <span class="n">new_grid_cell</span>
        <span class="n">grid_cell_msg</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
        <span class="n">grid_cell_msg</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_grid_cell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">grid_cell_msg</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_grid_cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">grid_cell_msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="PathFollower.airmar_speed_knots_callback"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.airmar_speed_knots_callback">[docs]</a>    <span class="k">def</span> <span class="nf">airmar_speed_knots_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Float64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_knots</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_look_ahead</span><span class="p">()</span></div>

<div class="viewcode-block" id="PathFollower.get_path"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.get_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">goal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GetPath</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_path with </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">goal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind_angle_deg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No wind reported yet, cannot path&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">GetPath</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>
        <span class="n">start_point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
        <span class="n">end_point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
        <span class="n">start_point</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">start_point</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">end_point</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">goal</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end_point</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">goal</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">req</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_point</span>
        <span class="n">req</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end_point</span>
        <span class="n">req</span><span class="o">.</span><span class="n">pathfinding_strategy</span> <span class="o">=</span> <span class="n">GetPath</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">PATHFINDING_STRATEGY_ASTAR</span>
        
        <span class="c1">#Pathfinder assumes 0 is along the +X axis. Airmar data is 0 along +y axis.</span>
        <span class="n">wind_angle_adjusted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind_angle_deg</span><span class="o">-</span><span class="mi">90</span>


        <span class="n">req</span><span class="o">.</span><span class="n">wind_angle_deg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wind_angle_adjusted</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting path&quot;</span><span class="p">)</span>
        <span class="c1">#synchronous service call because ROS2 async doesn&#39;t work in callbacks</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path_cli</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Path returned!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="PathFollower.calculate_initial_bearing"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.calculate_initial_bearing">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_initial_bearing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point_A</span><span class="p">,</span> <span class="n">point_B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">radians</span><span class="p">,</span> <span class="n">point_A</span><span class="p">)</span>
        <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">radians</span><span class="p">,</span> <span class="n">point_B</span><span class="p">)</span>

        <span class="n">dLon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dLon</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dLon</span><span class="p">))</span>
        <span class="n">initial_bearing</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">degrees</span><span class="p">(</span><span class="n">initial_bearing</span><span class="p">)</span></div>

<div class="viewcode-block" id="PathFollower.get_square_corners"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.get_square_corners">[docs]</a>    <span class="k">def</span> <span class="nf">get_square_corners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the corners of a square around point B, based on the direction from point A to B and a specified side length.</span>
<span class="sd">        The square is oriented such that its sides are either perpendicular or parallel to the line from A to B depending on the direction.</span>

<span class="sd">        :param A: A tuple (latitude, longitude) representing the starting point.</span>
<span class="sd">        :param B: A tuple (latitude, longitude) representing the end point or the center of the square.</span>
<span class="sd">        :param side_length: The side length of the square.</span>
<span class="sd">        :param direction: A string indicating the direction to rotate the square (&#39;right&#39; or &#39;left&#39;) around point B.</span>

<span class="sd">        :return: A list of tuples representing the geographic coordinates (latitude, longitude) of the square&#39;s corners.</span>
<span class="sd">                The order of corners depends on the specified direction.</span>

<span class="sd">        Function behavior includes:</span>
<span class="sd">        - Calculating the diagonal distance of the square based on the side length.</span>
<span class="sd">        - Determining the initial bearing from point A to point B.</span>
<span class="sd">        - Calculating bearings for each corner of the square using the initial bearing and adding specific angles.</span>
<span class="sd">        - Using the geodesic method to find the exact locations for each corner based on these bearings.</span>
<span class="sd">        - Returning the corners in a specific order depending on whether the direction is &#39;right&#39; or &#39;left&#39;.</span>

<span class="sd">        This function is used to calculate intermediate targets for buoy rounding maneuvers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert side length to diagonal distance</span>
        <span class="n">diagonal_distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">side_length</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Half diagonal for geodesic distance</span>
        
        <span class="k">def</span> <span class="nf">destination_point</span><span class="p">(</span><span class="n">start_point</span><span class="p">,</span> <span class="n">bearing</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">geodesic</span><span class="p">(</span><span class="n">meters</span><span class="o">=</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">destination</span><span class="p">(</span><span class="n">start_point</span><span class="p">,</span> <span class="n">bearing</span><span class="p">)</span>
        
        <span class="c1"># Initial point and bearing</span>
        <span class="n">bearing_AB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_initial_bearing</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">bearings</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bearing_AB</span> <span class="o">+</span> <span class="n">angle</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="o">-</span><span class="mi">135</span><span class="p">]]</span>  <span class="c1"># four bearings for a perpendicular square</span>
        
        <span class="n">point_B</span> <span class="o">=</span> <span class="n">geopy_point</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="c1"># 0, 1, 2, 3 = back right, back left, front right, front left</span>
        <span class="n">corners</span> <span class="o">=</span> <span class="p">[</span><span class="n">destination_point</span><span class="p">(</span><span class="n">point_B</span><span class="p">,</span> <span class="n">bearing</span><span class="p">,</span> <span class="n">diagonal_distance</span><span class="p">)</span> <span class="k">for</span> <span class="n">bearing</span> <span class="ow">in</span> <span class="n">bearings</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        
        <span class="c1">#This should not happen</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PathFollower.get_relevant_square_corners"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.get_relevant_square_corners">[docs]</a>    <span class="k">def</span> <span class="nf">get_relevant_square_corners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_point</span><span class="p">:</span> <span class="n">GeoPoint</span><span class="p">,</span> <span class="n">previous_point</span><span class="p">:</span> <span class="n">GeoPoint</span><span class="p">,</span> <span class="n">next_point</span><span class="p">:</span> <span class="n">GeoPoint</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="n">corners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_square_corners</span><span class="p">((</span><span class="n">previous_point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">previous_point</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="p">(</span><span class="n">target_point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">target_point</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">buoy_rounding_distance_meters</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target: </span><span class="si">{</span><span class="n">target_point</span><span class="si">}</span><span class="s2">, previous: </span><span class="si">{</span><span class="n">previous_point</span><span class="si">}</span><span class="s2">, next: </span><span class="si">{</span><span class="n">next_point</span><span class="si">}</span><span class="s2">, corners: </span><span class="si">{</span><span class="n">corners</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">next_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">corners</span>
        
        <span class="n">relevant</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">d0</span> <span class="o">=</span> <span class="n">great_circle</span><span class="p">(</span><span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">next_point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">next_point</span><span class="o">.</span><span class="n">longitude</span><span class="p">))</span><span class="o">.</span><span class="n">meters</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">great_circle</span><span class="p">(</span><span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">next_point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">next_point</span><span class="o">.</span><span class="n">longitude</span><span class="p">))</span><span class="o">.</span><span class="n">meters</span>
        <span class="k">if</span><span class="p">(</span><span class="n">d1</span><span class="o">&lt;</span><span class="n">d0</span><span class="p">):</span>
            <span class="n">relevant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">great_circle</span><span class="p">(</span><span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="n">next_point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">next_point</span><span class="o">.</span><span class="n">longitude</span><span class="p">))</span><span class="o">.</span><span class="n">meters</span>
        <span class="k">if</span><span class="p">(</span><span class="n">d2</span><span class="o">&lt;</span><span class="n">d1</span><span class="p">):</span>
            <span class="n">relevant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">relevant</span></div>

<div class="viewcode-block" id="PathFollower.remove_last_points_if_necessary"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.remove_last_points_if_necessary">[docs]</a>    <span class="k">def</span> <span class="nf">remove_last_points_if_necessary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_point</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes points from the list of exact points and grid points if they are deemed unnecessary based on their distance</span>
<span class="sd">        to a new point (&#39;next_point&#39;). This function is called when adding waypoints, and is intended to remove unwanted rounding </span>
<span class="sd">        segments generated around a previous rounding waypoint.</span>

<span class="sd">        :param next_point: A tuple (latitude, longitude) representing the next point&#39;s geographic coordinates.</span>

<span class="sd">        :return: None. Modifies the internal lists &#39;exact_points&#39; and &#39;grid_points&#39; by potentially removing points that</span>
<span class="sd">                are no longer relevant after analyzing the new point&#39;s proximity to the previous points.</span>

<span class="sd">        Function behavior includes:</span>
<span class="sd">        - Checking if the last processed waypoint was a rounding type.</span>
<span class="sd">        - Comparing distances between consecutive exact points and the next point.</span>
<span class="sd">        - Removing points from both &#39;exact_points&#39; and &#39;grid_points&#39; if the conditions indicate that newer points</span>
<span class="sd">        have looped back and are curther away than earlier points, requiring a path correction</span>

<span class="sd">        This function is intended to ensure buoy rounding paths are sensible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove points from last rounding waypoint if necessary</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_waypoint_was_rounding_type</span><span class="p">):</span>
            <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">num_points</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="p">[</span><span class="n">num_points</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">num_points</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">p0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="p">[</span><span class="n">num_points</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">d0</span> <span class="o">=</span> <span class="n">great_circle</span><span class="p">((</span><span class="n">p0</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">p0</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="n">next_point</span><span class="p">)</span><span class="o">.</span><span class="n">meters</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">great_circle</span><span class="p">((</span><span class="n">p1</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="n">next_point</span><span class="p">)</span><span class="o">.</span><span class="n">meters</span>
                <span class="k">if</span><span class="p">(</span><span class="n">num_points</span><span class="o">&gt;</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">d0</span><span class="o">&lt;</span><span class="n">d1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="p">[</span><span class="n">num_points</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">d2</span> <span class="o">=</span> <span class="n">great_circle</span><span class="p">((</span><span class="n">p2</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="n">next_point</span><span class="p">)</span><span class="o">.</span><span class="n">meters</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">d1</span><span class="o">&lt;</span><span class="n">d2</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></div>

<div class="viewcode-block" id="PathFollower.calculate_exact_points_from_waypoint"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.calculate_exact_points_from_waypoint">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_exact_points_from_waypoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waypoint_msg</span><span class="p">:</span> <span class="n">Waypoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes a waypoint message to calculate exact geographic points that the path follower node should navigate through.</span>
<span class="sd">        Depending on the type of waypoint, this function either calculates corner points for rounding maneuvers (either to the right or left), </span>
<span class="sd">        snapping to the closest buoy if within a defined proximity, or directly uses the waypoint&#39;s location.</span>

<span class="sd">        The function updates the current path with exact geographic points and grid coordinates on the current map.</span>

<span class="sd">        :param waypoint_msg: A sailbot_msgs/Waypoint message object containing waypoint information such as the latitude, longitude, and type of the waypoint.</span>

<span class="sd">        :return: None. The function updates the instance&#39;s &#39;exact_points&#39; and &#39;grid_points&#39; lists with the calculated points.</span>

<span class="sd">        Function behavior includes:</span>
<span class="sd">        - Checking each buoy position for proximity to the waypoint and snapping to the closest buoy if applicable.</span>
<span class="sd">        - Handling different types of waypoints like intersection, circle right, and circle left by generating respective path adjustments.</span>
<span class="sd">        - Logging various state changes and decisions for debugging and monitoring purposes.</span>
<span class="sd">        - Maintaining and updating the internal node state based on the type of the last waypoint processed.</span>

<span class="sd">        This function assumes that &#39;latitude&#39;, &#39;longitude&#39;, &#39;bbox&#39;,</span>
<span class="sd">        &#39;image_width&#39;, and &#39;image_height&#39; are available within the class instance and are appropriately set before calling this function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">closestDistance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">closestBuoyKey</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_buoy_positions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">buoy_detection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_buoy_positions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">geodesic</span><span class="p">((</span><span class="n">buoy_detection</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">buoy_detection</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="p">(</span><span class="n">waypoint_msg</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">waypoint_msg</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">longitude</span><span class="p">))</span><span class="o">.</span><span class="n">meters</span>
            <span class="k">if</span><span class="p">(</span><span class="n">distance</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">buoy_snap_distance_meters</span> <span class="ow">and</span> <span class="n">distance</span><span class="o">&lt;</span><span class="n">closestDistance</span><span class="p">):</span>
                <span class="n">closestDistance</span> <span class="o">=</span> <span class="n">distance</span>
                <span class="n">closestBuoyKey</span> <span class="o">=</span> <span class="n">key</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">waypoint_msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Waypoint</span><span class="o">.</span><span class="n">WAYPOINT_TYPE_INTERSECT</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intersect&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latlong_to_grid_proj</span><span class="p">(</span><span class="n">waypoint_msg</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">waypoint_msg</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_last_points_if_necessary</span><span class="p">(</span><span class="n">next_point</span><span class="o">=</span><span class="p">(</span><span class="n">waypoint_msg</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">waypoint_msg</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">longitude</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_waypoint_was_rounding_type</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waypoint_msg</span><span class="o">.</span><span class="n">point</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">previousPoint</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">previousPoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">previousPoint</span> <span class="o">=</span> <span class="n">GeoPoint</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>

            <span class="n">corners</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">adjustedPoint</span> <span class="o">=</span> <span class="n">waypoint_msg</span><span class="o">.</span><span class="n">point</span>
            <span class="k">if</span><span class="p">(</span><span class="n">closestBuoyKey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">adjustedPoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_buoy_positions</span><span class="p">[</span><span class="n">closestBuoyKey</span><span class="p">]</span>
                <span class="n">threat_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waypoint_threat_id_map</span><span class="p">[(</span><span class="n">waypoint_msg</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">waypoint_msg</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">longitude</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Threat of id </span><span class="si">{</span><span class="n">threat_id</span><span class="si">}</span><span class="s2"> being modified&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_threat</span><span class="p">(</span><span class="n">Waypoint</span><span class="p">(</span><span class="n">point</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_buoy_positions</span><span class="p">[</span><span class="n">closestBuoyKey</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="n">waypoint_msg</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="n">threat_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Snapping point to buoy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_buoy_positions</span><span class="p">[</span><span class="n">closestBuoyKey</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">waypoint_msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Waypoint</span><span class="o">.</span><span class="n">WAYPOINT_TYPE_CIRCLE_RIGHT</span><span class="p">:</span>
                <span class="n">corners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_square_corners</span><span class="p">((</span><span class="n">previousPoint</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">previousPoint</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="p">(</span><span class="n">adjustedPoint</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">adjustedPoint</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">buoy_rounding_distance_meters</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circle right </span><span class="si">{</span><span class="n">corners</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">waypoint_msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Waypoint</span><span class="o">.</span><span class="n">WAYPOINT_TYPE_CIRCLE_LEFT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circle left </span><span class="si">{</span><span class="n">corners</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">corners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_square_corners</span><span class="p">((</span><span class="n">previousPoint</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">previousPoint</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="p">(</span><span class="n">adjustedPoint</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">adjustedPoint</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">buoy_rounding_distance_meters</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">remove_last_points_if_necessary</span><span class="p">(</span><span class="n">next_point</span><span class="o">=</span><span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">corners</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latlong_to_grid_proj</span><span class="p">(</span><span class="n">corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">corner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GeoPoint</span><span class="p">(</span><span class="n">latitude</span> <span class="o">=</span> <span class="n">corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">longitude</span> <span class="o">=</span> <span class="n">corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">last_waypoint_was_rounding_type</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PathFollower.recalculate_path_from_exact_points"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.recalculate_path_from_exact_points">[docs]</a>    <span class="k">def</span> <span class="nf">recalculate_path_from_exact_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recalculates the current path based on exact geographic points and grid coordinates determined by previous processing.</span>
<span class="sd">        This function constructs the path segment by segment, updating it with any changes in conditions or coordinates.</span>

<span class="sd">        The function checks for wind conditions, recalculates path segments between exact points, and publishes the updated path.</span>

<span class="sd">        :return: None. The function directly updates the &#39;current_path&#39; and &#39;current_grid_path&#39; attributes of the instance, </span>
<span class="sd">                and publishes the new path to a designated topic.</span>

<span class="sd">        Function behavior includes:</span>
<span class="sd">        - Verifying if wind conditions are reported; if not, the function logs a message and exits without updating the path.</span>
<span class="sd">        - If there are no waypoints to process (i.e., if &#39;grid_points&#39; is empty), the function clears the current path and logs this event.</span>
<span class="sd">        - Creating a new path by connecting all exact points through calculated segments, while taking into account wind angle.</span>
<span class="sd">        - Dynamically inserting intermediate points into path segments to enhance navigation precision.</span>
<span class="sd">        - Publishing the newly calculated path for use by the navigation system.</span>
<span class="sd">        - Logging various state changes and decisions for debugging and monitoring purposes.</span>

<span class="sd">        This function assumes that &#39;current_grid_cell&#39; and &#39;grid_points&#39; are available within the class instance </span>
<span class="sd">        and are appropriately set before calling this function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
         
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind_angle_deg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No wind reported yet, cannot path&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Reset look-ahead, since previous values are not relevant anymore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_look_ahead_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Empty waypoints, will clear path&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">GeoPath</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_path_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_path</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">path_segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">path_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">path_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculated all path segments&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">path_segments</span><span class="p">:</span>
           <span class="n">segment</span><span class="o">.</span><span class="n">poses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_intermediate_points</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">poses</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

        <span class="n">final_path</span> <span class="o">=</span> <span class="n">GeoPath</span><span class="p">()</span>
        <span class="n">final_grid_path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span><span class="o">=-</span><span class="mi">1</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">final_grid_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">y</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">final_path</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GeoPoint</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">))</span>

        <span class="c1"># Track the indices in the current path which correspond to endpoints of straight-line path segments</span>
        <span class="n">segment_endpoint_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">path_segments</span><span class="p">:</span>
            <span class="c1">#skip failed waypoints</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">poses</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">continue</span> 

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">poses</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">poseStamped</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">poses</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">poseStamped</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;point: </span><span class="si">{</span><span class="n">point</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_to_latlong_proj</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">point</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">)</span>
                <span class="n">geopoint</span> <span class="o">=</span> <span class="n">GeoPoint</span><span class="p">()</span>
                <span class="n">geopoint</span><span class="o">.</span><span class="n">latitude</span> <span class="o">=</span> <span class="n">lat</span>
                <span class="n">geopoint</span><span class="o">.</span><span class="n">longitude</span> <span class="o">=</span> <span class="n">lon</span>
                <span class="c1">#append latlon position to global path, and grid point to grid path</span>
                <span class="n">final_path</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geopoint</span><span class="p">)</span>
                <span class="n">final_grid_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
            <span class="c1">#append exact final position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;num exact points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="p">)</span><span class="si">}</span><span class="s2">, i: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">final_path</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">final_grid_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">poses</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">poses</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
            <span class="n">segment_endpoint_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">poses</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#self.waypoint_indices.append(k)</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New path: </span><span class="si">{</span><span class="n">final_path</span><span class="o">.</span><span class="n">points</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_path_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">final_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">final_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_path</span> <span class="o">=</span> <span class="n">final_grid_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segment_endpoint_indices</span> <span class="o">=</span> <span class="n">segment_endpoint_indices</span></div>

    <span class="c1">#currently only used to clear points.</span>
<div class="viewcode-block" id="PathFollower.waypoints_callback"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.waypoints_callback">[docs]</a>    <span class="k">def</span> <span class="nf">waypoints_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">WaypointPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got waypoints!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waypoints</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_threats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recalculate_path_from_exact_points</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_look_ahead</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ending waypoints callback&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PathFollower.clear_threats"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.clear_threats">[docs]</a>    <span class="k">def</span> <span class="nf">clear_threats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threat_ids</span><span class="p">:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">SetThreat</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>
            <span class="n">req</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
            <span class="n">req</span><span class="o">.</span><span class="n">remove</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing threat&quot;</span><span class="p">)</span>
            <span class="c1">#synchronous service call because ROS2 async doesn&#39;t work in callbacks</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_threat_cli</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Threat removed&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PathFollower.add_threat"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.add_threat">[docs]</a>    <span class="k">def</span> <span class="nf">add_threat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waypoint</span><span class="p">:</span> <span class="n">Waypoint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a threat to the system based on a waypoint&#39;s geographic location by converting it into a Gaussian threat model.</span>
<span class="sd">        This function also performs a synchronous service call to register the threat in the system and optionally map the threat ID</span>
<span class="sd">        back to the waypoint for subsequent adjustments.</span>

<span class="sd">        :param waypoint: A &#39;Waypoint&#39; object that contains the latitude and longitude of the threat location.</span>
<span class="sd">        :param id: An optional integer specifying the threat ID. If set to -1, a new threat ID is requested. Default is -1.</span>

<span class="sd">        :return: None. The function updates the system with a new or adjusted threat model and logs the response.</span>

<span class="sd">        Function behavior includes:</span>
<span class="sd">        - Calculating grid coordinates from the waypoint&#39;s geographic coordinates.</span>
<span class="sd">        - Configuring a GaussianThreat object with predefined size and intensity.</span>
<span class="sd">        - Making a synchronous service call to set the threat in the pathfinding system.</span>
<span class="sd">        - Logging the setting process and the response, including the assigned threat ID.</span>
<span class="sd">        - Storing the assigned threat ID for position adjustment and reference.</span>

<span class="sd">        This function assumes that &#39;buoy_threat_size_map_units&#39;, &#39;buoy_threat_gaussian_intensity&#39;,</span>
<span class="sd">        &#39;bbox&#39;, &#39;image_width&#39;, &#39;image_height&#39;, and &#39;set_threat_cli&#39; (a ROS2 service client) are properly configured and available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">threat</span> <span class="o">=</span> <span class="n">GaussianThreat</span><span class="p">()</span>
        <span class="n">threat</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buoy_threat_size_map_units</span>
        <span class="n">threat</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buoy_threat_guassian_intensity</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latlong_to_grid_proj</span><span class="p">(</span><span class="n">waypoint</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">)</span>
        <span class="n">threat</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">threat</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="n">req</span> <span class="o">=</span> <span class="n">SetThreat</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>
        <span class="n">req</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="n">req</span><span class="o">.</span><span class="n">threat</span> <span class="o">=</span> <span class="n">threat</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting threat&quot;</span><span class="p">)</span>
        <span class="c1">#synchronous service call because ROS2 async doesn&#39;t work in callbacks</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_threat_cli</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Threat id returned: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">assigned_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># for position adjustment later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waypoint_threat_id_map</span><span class="p">[(</span><span class="n">waypoint</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">longitude</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">assigned_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threat_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">assigned_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="PathFollower.single_waypoint_callback"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.single_waypoint_callback">[docs]</a>    <span class="k">def</span> <span class="nf">single_waypoint_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Waypoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback function that processes a single waypoint message. This function updates the waypoint list, calculates exact points, </span>
<span class="sd">        recalculates the path, and determines the look-ahead point based on the received waypoint message.</span>

<span class="sd">        :param msg: A sailbot_msgs/Waypoint object that contains details such as the type of waypoint and its geographic coordinates.</span>

<span class="sd">        :return: None. This function triggers a series of operations that update the internal state of the navigation system, </span>
<span class="sd">                including appending the waypoint to a list, potentially adding a threat to the map based on the waypoint type, </span>
<span class="sd">                recalculating the navigation path, and updating the look-ahead mechanism.</span>

<span class="sd">        Function behavior includes:</span>
<span class="sd">        - Logging receipt of a new waypoint.</span>
<span class="sd">        - Appending the new waypoint to the &#39;waypoints&#39; list.</span>
<span class="sd">        - Adding the waypoint as a threat if it is a rounding waypoint (either to the right or left).</span>
<span class="sd">        - Calling the function to calculate exact points from the new waypoint.</span>
<span class="sd">        - Recalculating the entire path based on updated waypoint data.</span>
<span class="sd">        - Determining and updating the look-ahead point for navigation.</span>
<span class="sd">        - Logging the completion of processing for the waypoint.</span>

<span class="sd">        This function is intended to be used as a callback for a waypoint message subscriber in a ROS2 node environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got single waypoint&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waypoints</span><span class="o">.</span><span class="n">waypoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Waypoint</span><span class="o">.</span><span class="n">WAYPOINT_TYPE_CIRCLE_RIGHT</span> <span class="ow">or</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Waypoint</span><span class="o">.</span><span class="n">WAYPOINT_TYPE_CIRCLE_LEFT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_threat</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_exact_points_from_waypoint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recalculate_path_from_exact_points</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_look_ahead</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ending single waypoint callback&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PathFollower.true_wind_callback"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.true_wind_callback">[docs]</a>    <span class="k">def</span> <span class="nf">true_wind_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Wind</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wind_angle_deg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">direction</span></div>

<div class="viewcode-block" id="PathFollower.buoy_position_callback"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.buoy_position_callback">[docs]</a>    <span class="k">def</span> <span class="nf">buoy_position_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">BuoyDetectionStamped</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_buoy_positions</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span></div>
    
<div class="viewcode-block" id="PathFollower.find_look_ahead"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.find_look_ahead">[docs]</a>    <span class="k">def</span> <span class="nf">find_look_ahead</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines and updates the vector field target segment based on the current navigation path. </span>
<span class="sd">        This function also handles publishing various navigation-related messages to update</span>
<span class="sd">        the system&#39;s state and debug information.</span>

<span class="sd">        :return: None. This function modifies the navigation state by publishing the current grid cell, target position, </span>
<span class="sd">                and path segments for display or further processing.</span>

<span class="sd">        Function behavior includes:</span>
<span class="sd">        - Publishing the current grid cell position.</span>
<span class="sd">        - Early exit if the path has zero length.</span>
<span class="sd">        - Iterating through path points to find the appropriate target path segment based on calculated distance.</span>
<span class="sd">        - Conditionally publishing target positions and path segments for system updates and debugging.</span>
<span class="sd">        - Checking if the next path point is closer than the current target to avoid backtracking.</span>
<span class="sd">        - Managing and removing passed exact points to maintain an updated path.</span>

<span class="sd">        This function assumes that instance attributes &#39;latitude&#39;, &#39;longitude&#39;, &#39;current_path&#39;, </span>
<span class="sd">        &#39;current_grid_path&#39;, and &#39;exact_points&#39; are properly initialized and available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grid_cell_msg</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
        <span class="n">grid_cell_msg</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">grid_cell_msg</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_cell_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">grid_cell_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#self.get_logger().info(&quot;No lookAhead point for zero-length path&quot;)</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid path length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_grid_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">points</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_look_ahead_index</span><span class="p">,</span> <span class="n">num_points</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">great_circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">point</span><span class="o">.</span><span class="n">longitude</span><span class="p">))</span><span class="o">.</span><span class="n">meters</span>
            <span class="c1"># Check if the next point is closer. If so, we probably skipped some points. Don&#39;t target them. </span>
            <span class="n">next_is_closer</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="n">num_points</span> <span class="k">else</span> <span class="p">(</span><span class="kc">True</span> <span class="k">if</span> <span class="n">great_circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">))</span><span class="o">.</span><span class="n">meters</span><span class="o">&lt;</span><span class="n">distance</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;next_is_closer: </span><span class="si">{</span><span class="n">next_is_closer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">next_is_closer</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previous_look_ahead_index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calulated current point: </span><span class="si">{</span><span class="n">point</span><span class="o">.</span><span class="n">latitude</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">point</span><span class="o">.</span><span class="n">longitude</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_position_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="c1"># In this version, this is just for display in the UI. This is NOT an input to heading_controller_vf </span>
                <span class="n">segment</span> <span class="o">=</span> <span class="n">PathSegment</span><span class="p">()</span>
                <span class="n">segment</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">segment</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_grid_segment_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
                <span class="n">geoSegment</span> <span class="o">=</span> <span class="n">GeoPathSegment</span><span class="p">()</span>
                <span class="n">geoSegment</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">geoSegment</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_path</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_segment_debug_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">geoSegment</span><span class="p">)</span>

                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#remove exact points if we&#39;ve passed them</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Point is: </span><span class="si">{</span><span class="n">point</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">latitude</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span> <span class="ow">and</span> <span class="n">point</span><span class="o">.</span><span class="n">longitude</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing passed exact point&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">grid_points</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exact_points</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="PathFollower.vector_to_heading"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.vector_to_heading">[docs]</a>    <span class="k">def</span> <span class="nf">vector_to_heading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert vector components (dx, dy) at a grid position to a navigation heading.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - dx, dy: Changes in x and y grid coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - Navigation bearing in degrees from north.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>  <span class="c1"># Angle in radians</span>
        <span class="n">bearing</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">%</span> <span class="mi">360</span>
        <span class="k">return</span> <span class="n">bearing</span></div>

<div class="viewcode-block" id="PathFollower.latlong_to_grid_proj"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.latlong_to_grid_proj">[docs]</a>    <span class="k">def</span> <span class="nf">latlong_to_grid_proj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">longitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">bbox</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">image_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">image_height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">src_proj</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="n">dest_proj</span><span class="o">=</span><span class="s1">&#39;EPSG:3857&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert latitude and longitude coordinates to grid cell coordinates using pyproj for projection handling.</span>

<span class="sd">        :param latitude: The latitude coordinate to convert.</span>
<span class="sd">        :param longitude: The longitude coordinate to convert.</span>
<span class="sd">        :param bbox: A dictionary with keys &#39;north&#39;, &#39;south&#39;, &#39;east&#39;, &#39;west&#39; representing the bounding box.</span>
<span class="sd">        :param image_width: The width of the image in pixels.</span>
<span class="sd">        :param image_height: The height of the image in pixels.</span>
<span class="sd">        :param src_proj: Source projection (usually latitude/longitude).</span>
<span class="sd">        :param dest_proj: Destination projection for converting geographic coordinates into grid coordinates.</span>

<span class="sd">        :return: A tuple (x, y) representing the grid cell coordinates in the image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">src_proj</span><span class="p">,</span> <span class="n">dest_proj</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">north_east</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">])</span>
        <span class="n">south_west</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">])</span>
        
        <span class="n">point_x</span><span class="p">,</span> <span class="n">point_y</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">)</span>
        
        <span class="c1"># Calculate the percentage within the transformed bounding box</span>
        <span class="n">long_pct</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="n">north_east</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">point_y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">north_east</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">south_west</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lat_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">point_x</span> <span class="o">-</span> <span class="n">south_west</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">north_east</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">south_west</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#self.get_logger().info(f&quot;lat_pct: {lat_pct}, long_pct: {long_pct}&quot;)</span>
        
        <span class="c1"># Convert percentages to pixel positions</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">long_pct</span> <span class="o">*</span> <span class="n">image_width</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lat_pct</span> <span class="o">*</span> <span class="n">image_height</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>

<div class="viewcode-block" id="PathFollower.grid_to_latlong_proj"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.grid_to_latlong_proj">[docs]</a>    <span class="k">def</span> <span class="nf">grid_to_latlong_proj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">bbox</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">image_width</span><span class="p">,</span> <span class="n">image_height</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert grid cell coordinates in an image to latitude/longitude coordinates using specified projections.</span>

<span class="sd">        :param x: The x-coordinate (pixel position) in the image.</span>
<span class="sd">        :param y: The y-coordinate (pixel position) in the image.</span>
<span class="sd">        :param bbox: A dictionary with keys &#39;north&#39;, &#39;south&#39;, &#39;east&#39;, &#39;west&#39; representing the bounding box.</span>
<span class="sd">        :param image_width: The width of the image in pixels.</span>
<span class="sd">        :param image_height: The height of the image in pixels.</span>

<span class="sd">        :return: A tuple (latitude, longitude) representing the geographic coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Transform the bounding box to the destination projection</span>
        <span class="n">north_east</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">])</span>
        <span class="n">south_west</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">])</span>

        <span class="n">lat_res</span> <span class="o">=</span>  <span class="nb">abs</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">image_height</span>
        <span class="n">long_res</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">image_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lat res: </span><span class="si">{</span><span class="n">lat_res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Long res: </span><span class="si">{</span><span class="n">long_res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate the geographical coordinates from the pixel positions</span>
        <span class="n">long_pct</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">image_width</span>
        <span class="n">lat_pct</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">image_height</span><span class="p">)</span>
        
        <span class="c1"># Interpolate the latitude and longitude within the bounding box</span>
        <span class="n">latitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">north_east</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lat_pct</span> <span class="o">*</span> <span class="p">(</span><span class="n">north_east</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">south_west</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="p">(</span><span class="n">lat_res</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">longitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">south_west</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">long_pct</span> <span class="o">*</span> <span class="p">(</span><span class="n">north_east</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">south_west</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="p">(</span><span class="n">long_res</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span></div>
    
<div class="viewcode-block" id="PathFollower.insert_intermediate_points"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.PathFollower.insert_intermediate_points">[docs]</a>    <span class="k">def</span> <span class="nf">insert_intermediate_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">num_per_unit_distance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PoseStamped</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts intermediate points into a given path segment to simplify more granular path following.</span>
<span class="sd">        The number of points inserted between each pair of original points is determined by the distance between them</span>
<span class="sd">        multiplied by a specified factor (&#39;num_per_unit_distance&#39;).</span>

<span class="sd">        :param path: A list of &#39;PoseStamped&#39; objects representing the waypoints of a path segment.</span>
<span class="sd">        :param num_per_unit_distance: A floating point number that determines how many points to insert per unit of distance</span>
<span class="sd">                                    between each pair of consecutive waypoints in the path.</span>

<span class="sd">        :return: A list of &#39;PoseStamped&#39; objects with the newly inserted intermediate points included.</span>

<span class="sd">        Function behavior includes:</span>
<span class="sd">        - Logging a warning and returning the original path if it has zero length.</span>
<span class="sd">        - Dynamically calculating the number of intermediate points to insert based on the distance between consecutive waypoints.</span>
<span class="sd">        - Using linear interpolation to determine the position of each intermediate point between each consecutive waypoint pair.</span>
<span class="sd">        - Returning a new path list that includes both the original and the newly interpolated points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">length</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Called insert_intermediate_points on a zero length segment!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="n">appended</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">num</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">num_per_unit_distance</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Num to insert: </span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">appended</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">x_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X step: </span><span class="si">{</span><span class="n">x_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">y_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;y step: </span><span class="si">{</span><span class="n">y_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">new_x</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="o">+</span><span class="n">x_step</span><span class="o">*</span><span class="n">j</span>
                    <span class="n">new_y</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="o">+</span><span class="n">y_step</span><span class="o">*</span><span class="n">j</span>
                    <span class="n">new_point</span> <span class="o">=</span> <span class="n">PoseStamped</span><span class="p">()</span>
                    <span class="n">new_point</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">new_x</span>
                    <span class="n">new_point</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">new_y</span>
                    <span class="n">appended</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_point</span><span class="p">)</span>
        <span class="n">appended</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">appended</span></div></div>



<div class="viewcode-block" id="main"><a class="viewcode-back" href="../path_follower_vf.html#path_follower_vf.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">path_follower</span> <span class="o">=</span> <span class="n">PathFollower</span><span class="p">()</span>

    <span class="c1"># Use the SingleThreadedExecutor to spin the node.</span>
    <span class="n">executor</span> <span class="o">=</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">executors</span><span class="o">.</span><span class="n">MultiThreadedExecutor</span><span class="p">()</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">path_follower</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Spin the node to execute callbacks</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">path_follower</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unhandled exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">trace</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Shutdown and cleanup the node</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">path_follower</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">sailbot</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../airmar_reader.html">Airmar Reader Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ballast_control.html">Ballast Control Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../buoy_detection.html">Buoy Detection Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../esp32_comms.html">ESP32 Comms Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../heading_controller_vf.html">Heading Controller Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network_comms.html">Network Comms Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../path_follower_vf.html">Path Follower Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../state_manager.html">State Manager Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wind_smoother.html">Wind Smoother Node</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2024, Matthew Gomes.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>